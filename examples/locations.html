<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>EPUB.JS: Locations - Example</title>
	<link rel="icon" type="image/png" href="../assets/favicon.png">
	<link rel="stylesheet" type="text/css" href="examples.css">
	<script src="../dist/epub.js"></script>
</head>

<body>
	<div id="content">
		<div id="viewer" class="paginated">
			<div id="divider"></div>
		</div>
		<a id="prev" href="#prev" class="arrow"></a>
		<a id="next" href="#next" class="arrow"></a>
	</div>
	<div id="controls">
		<div class="box">
			<input type="range" min="0" max="100" value="0" id="slider" />
			<label id="current-percent" for="slider"></label>
		</div>
	</div>
	<script>
		const content = document.getElementById("content")
		const divider = document.getElementById("divider")
		const controls = document.getElementById("controls")
		const label = document.getElementById("current-percent")
		const slider = document.getElementById("slider")
		const prev = document.getElementById("prev")
		const next = document.getElementById("next")
		const book = ePub("../test/fixtures/alice/OPS/package.opf")
		const rendition = book.renderTo("viewer", {
			width: "100%",
			height: "100%"
		})
		rendition.display()
		let percentage
		slider.onchange = (e) => {

			percentage = parseInt(e.target.value) / 100
			book.locations.set({ percentage: percentage })
			rendition.display(book.locations.current.cfi)
		}
		prev.onclick = (e) => {

			rendition.prev()
			e.preventDefault()
		}
		next.onclick = (e) => {

			rendition.next()
			e.preventDefault()
		}
		let atStart = false, atEnd = false
		const update = (location) => {

			const dir = rendition.layout.direction
			const div = rendition.layout.divisor
			const loc = location || rendition.currentLocation()
			prev.style.display = loc.atStart ? "none" : "block"
			next.style.display = loc.atEnd ? "none" : "block"
			divider.style.display = div === 1 ? "none" : "block"
			content.dir = dir

			if (typeof percentage === "undefined") {
				book.locations.set({ cfi: location.start.cfi })
				percentage = book.locations.current.percentage || 0
			}

			const value = Math.floor(percentage * 100)
			slider.value = value
			label.textContent = value + " %"
			percentage = undefined
		}
		const keybinding = (e) => {

			const dir = rendition.layout.direction
			switch (e.key) {
				case "ArrowLeft":
					dir === "ltr" ? rendition.prev() : rendition.next()
					break;
				case "ArrowRight":
					dir === "ltr" ? rendition.next() : rendition.prev()
					break;
			}
		}
		book.ready.then(() => {
			// Load in stored locations from json or local storage
			const key = book.key() + '-locations'
			const stored = localStorage.getItem(key)
			if (stored) {
				return book.locations.load(stored)
			} else {
				// Or generate the locations on the fly
				// Can pass an option number of chars to break sections by
				// default is 150 chars
				// test: [break:549,items:101] (sections:2-12,pages:37)
				//  2:[0]
				//  3:[1-4-8-12]
				//  4:[14-18-21-24]
				//  5:[25-28-31-34-35]
				//  6:[36-41-44-48]
				//  7:[50-53-56-60]
				//  8:[61-65-69]
				//  9:[71-74-76]
				// 10:[77-81-84-88]
				// 11:[89-92]
				// 12:[95-98-100]
				return book.locations.generate(549)
			}
		}).then((locations) => {

			// Save out the generated locations to JSON
			localStorage.setItem(book.key() + '-locations', book.locations.save())
			console.log("locations.length: " + locations.length)
		})
		book.locations.on("changed", (current, changed) => {

			console.log(current, changed)
		})
		rendition.on("displayed", (section) => {

			document.onkeyup = keybinding
			rendition.on("keyup", keybinding)
		})
		rendition.on("relocated", (location) => {

			update(location)
			console.log(location)
		})
	</script>
</body>

</html>